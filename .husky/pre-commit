#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# Pre-commit hook
echo "ğŸ” Running pre-commit checks..."

# Run lint-staged (Biome.js on staged files)
echo "ğŸ“ Linting and formatting staged files..."
npx lint-staged

# Type checking
echo "ğŸ”§ Running TypeScript type check..."
npm run type-check

# Run tests - optimized for speed and reliability
echo "ğŸ§ª Running tests..."

# Get staged files that might have tests
staged_files=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|js)$' | grep -v node_modules | tr '\n' ' ')

if [ -n "$staged_files" ] && [ "$staged_files" != " " ]; then
    echo "ğŸ” Running tests for changed files..."
    # Try to run related tests, fall back to all tests if it fails
    npm run test -- --findRelatedTests $staged_files --passWithNoTests --bail --silent || {
        echo "âš ï¸  Related tests failed, running all tests..."
        npm run test -- --passWithNoTests --bail --silent
    }
else
    echo "ğŸ“ No staged source files, running all tests..."
    npm run test -- --passWithNoTests --bail --silent
fi

echo "âœ… Pre-commit checks passed!"

#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# Pre-push hook
echo "ğŸš€ Running pre-push checks..."

# Get current branch
branch=$(git rev-parse --abbrev-ref HEAD)
echo "ğŸ“‹ Current branch: $branch"

# Run full validation suite
echo "ğŸ” Running full validation..."
npm run validate

# Build the project to ensure it compiles
echo "ğŸ”¨ Building project..."
npm run build

# Check if we're pushing to main/master - require clean working directory
if [ "$branch" = "main" ] || [ "$branch" = "master" ]; then
    echo "âš ï¸  Pushing to $branch - running additional checks..."
    
    # Ensure no uncommitted changes
    if [ -n "$(git status --porcelain)" ]; then
        echo "âŒ Error: You have uncommitted changes. Please commit or stash them before pushing to $branch."
        exit 1
    fi
    
    # Run tests with coverage
    echo "ğŸ“Š Running tests with coverage..."
    npm run test:coverage
    
    echo "âœ… All checks passed for $branch!"
else
    echo "âœ… Pre-push checks passed for feature branch!"
fi
